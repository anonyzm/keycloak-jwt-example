# Система автоматического обновления токенов

## Обзор

Фронтенд теперь автоматически обрабатывает 401 ошибки (Unauthorized) и получает новый гостевой токен при необходимости. Это обеспечивает бесперебойную работу приложения даже при истечении токенов.

## Основные компоненты

### 1. httpClient.ts
Центральный HTTP-клиент с автоматической обработкой токенов:
- Автоматически добавляет токен к каждому запросу
- При получении 401 ошибки автоматически получает новый гостевой токен
- Повторяет неудачный запрос с новым токеном
- Предотвращает бесконечные циклы повторных попыток

### 2. authService.ts
Сервис аутентификации с улучшенной логикой:
- `ensureValidToken()` - проверяет валидность токена и обновляет при необходимости
- `forceRefreshGuestToken()` - принудительно обновляет гостевой токен
- Автоматическая очистка истекших токенов
- Логирование всех операций с токенами

### 3. demoService.ts
Обновленный сервис для демо-запросов:
- Использует `httpClient` вместо прямых вызовов axios
- Автоматически получает валидный токен перед каждым запросом
- Не требует ручной обработки токенов

## Как это работает

1. **При каждом запросе**: `httpClient` автоматически проверяет валидность токена
2. **При 401 ошибке**: 
   - Очищается старый токен
   - Автоматически запрашивается новый гостевой токен
   - Оригинальный запрос повторяется с новым токеном
3. **Логирование**: Все операции логируются в консоль для отладки

## Использование

### Простое использование (рекомендуется)
```typescript
import httpClient from './services/httpClient';

// Автоматически добавляет токен и обрабатывает 401 ошибки
const response = await httpClient.get('/api/endpoint');
```

### Использование через сервисы
```typescript
import { demoService } from './services/demoService';

// Автоматически получает валидный токен и делает запрос
const userInfo = await demoService.getUserOnlyInfo();
```

### Ручное управление токенами
```typescript
import { authService } from './services/authService';

// Принудительное обновление токена
await authService.forceRefreshGuestToken();

// Проверка и получение валидного токена
const token = await authService.ensureValidToken();
```

## Преимущества

1. **Автоматичность**: Не нужно вручную обрабатывать 401 ошибки
2. **Надежность**: Автоматическое восстановление после истечения токенов
3. **Прозрачность**: Логирование всех операций для отладки
4. **Простота**: Минимальные изменения в существующем коде
5. **Безопасность**: Предотвращение бесконечных циклов повторных попыток

## Логирование

Система ведет подробные логи в консоли:
- Получение 401 ошибки
- Попытки обновления токена
- Успешное обновление токена
- Повторные попытки запросов
- Ошибки при обновлении токена

## Обработка ошибок

Если не удается получить новый гостевой токен:
1. Токен очищается из localStorage
2. Ошибка передается в вызывающий код
3. Приложение может показать сообщение об ошибке или перенаправить на страницу входа

## Миграция существующего кода

Для миграции существующих сервисов:

1. Заменить прямые вызовы `axios` на `httpClient`
2. Убрать ручную проверку токенов
3. Убрать ручную обработку 401 ошибок

**Было:**
```typescript
const response = await axios.get('/api/endpoint', {
  headers: { Authorization: `Bearer ${token}` }
});
```

**Стало:**
```typescript
const response = await httpClient.get('/api/endpoint');
```
